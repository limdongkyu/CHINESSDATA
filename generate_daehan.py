#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
대한검정회(한자급수자격검정) 기준 급수별 배정한자 생성 스크립트
8급(30) → 7급(50) → 6급(70) → 준5급(100) → 5급(250) → 준4급(400) → 4급(600)
나무위키 한자급수자격검정/배정한자 기준
"""

import json
import os

# 기존 데이터에서 문자별 정보 추출용
def load_char_db():
    """기존 JSON에서 character → entry 매핑 구축"""
    db = {}
    for fname in ["default4.json", "default5.json", "default6.json", "default7.json", "default8.json"]:
        if not os.path.exists(fname):
            continue
        with open(fname, "r", encoding="utf-8") as f:
            data = json.load(f).get("data", [])
        for e in data:
            c = e["character"]
            if c not in db:
                db[c] = e.copy()
    return db

def make_entry(char, meaning, sound, strokes, words=None):
    """엔트리 생성"""
    if words is None:
        words = [
            (f"{char}字", f"{sound}자", f"{meaning} 글자"),
            (f"{char}文", f"{sound}문", f"{meaning} 글"),
            (f"{char}語", f"{sound}어", f"{meaning} 말"),
            (f"{char}學", f"{sound}학", f"{meaning} 배움"),
            (f"{char}業", f"{sound}업", f"{meaning} 업"),
        ]
    return {
        "character": char,
        "meaning": meaning,
        "sound": sound,
        "strokeCount": strokes,
        "words": [{"hanja": w[0], "reading": w[1], "meaning": w[2]} for w in words]
    }

# 대한검정회 8급 30자 (나무위키)
GRADE8 = "九金南男女東六母木門父北四三西水十五月二人日子弟七八兄火"
GRADE8_HUNUM = [
    ("九","아홉","구"),("金","쇠","금"),("南","남녘","남"),("男","사내","남"),("女","여자","녀"),
    ("東","동녘","동"),("六","여섯","륙"),("母","어머니","모"),("木","나무","목"),("門","문","문"),
    ("父","아버지","부"),("北","북녘","북"),("四","넉","사"),("三","석","삼"),("西","서녘","서"),
    ("水","물","수"),("十","열","십"),("五","다섯","오"),("月","달","월"),("二","두","이"),
    ("人","사람","인"),("一","한","일"),("日","날","일"),("子","아들","자"),("弟","아우","제"),
    ("七","일곱","칠"),("八","여덟","팔"),("兄","맏","형"),("火","불","화"),
]
# 7급 신출 20자
GRADE7_NEW = "江口內年大目白山小手足外右入足左中靑出下"
GRADE7_HUNUM = [
    ("江","강","강"),("口","입","구"),("內","안","내"),("年","해","년"),("大","큰","대"),
    ("目","눈","목"),("白","흰","백"),("山","메","산"),("上","위","상"),("小","작을","소"),
    ("手","손","수"),("足","발","족"),("外","바깥","외"),("右","오른","우"),("入","들","입"),
    ("左","왼","좌"),("中","가운데","중"),("靑","푸를","청"),("出","날","출"),("下","아래","하"),
]
# 6급 신출 20자
GRADE6_NEW = "犬己林馬名百生石先姓心羊魚玉牛耳地川千天"
GRADE6_HUNUM = [
    ("犬","개","견"),("己","몸","기"),("林","수풀","림"),("馬","말","마"),("名","이름","명"),
    ("百","일백","백"),("生","날","생"),("石","돌","석"),("先","먼저","선"),("姓","성씨","성"),
    ("心","마음","심"),("羊","양","양"),("魚","물고기","어"),("玉","구슬","옥"),("牛","소","우"),
    ("耳","귀","이"),("地","땅","지"),("川","내","천"),("千","일천","천"),("天","하늘","천"),
]
# 준5급 신출 30자
GRADE_PRE5_NEW = "車巾古工今同力立末文方本夫不士夕世少食央王位衣字自正主寸向休"
GRADE_PRE5_HUNUM = [
    ("車","수레","거"),("巾","수건","건"),("古","예","고"),("工","장인","공"),("今","이제","금"),
    ("同","한가지","동"),("力","힘","력"),("立","설","립"),("末","끝","말"),("文","글월","문"),
    ("方","모","방"),("本","근본","본"),("夫","지아비","부"),("不","아니","불"),("士","선비","사"),
    ("夕","저녁","석"),("世","세상","세"),("少","적을","소"),("食","먹을","식"),("央","가운데","앙"),
    ("王","임금","왕"),("位","자리","위"),("衣","옷","의"),("字","글자","자"),("自","스스로","자"),
    ("正","바를","정"),("主","주인","주"),("寸","마디","촌"),("向","향할","향"),("休","쉴","휴"),
]
# 5급 신출 150자 (나무위키 순서)
GRADE5_NEW = (
    "歌家各間强開去見京計高功空共科光敎交校區國軍近急旗記氣農多短答當對代道"
    "刀讀冬洞頭等登樂來老理里利萬每面命文明毛無聞問物米民班半放番別步部分社事"
    "死色書線性成所首詩時示市植神身信新室安夜弱語言永英午用友遠原元有肉育銀"
    "音邑意作長場才田電前全朝祖晝住竹重直草村秋春親太通貝便平夏學韓漢合海行"
    "血形花話和活黃會孝後"
)
# 준4급 신출 150자
GRADE_PRE4_NEW = (
    "加可角感客格決結輕敬界苦考告曲公果過球郡貴根級吉能堂待德圖度童動落良歷"
    "例禮路勞綠流李亡買賣美朴反發法兵病福服奉冰仕思史使算相席雪省洗消速孫樹"
    "數宿順術習勝始式臣實失兒愛野藥陽洋漁億業如然溫要勇雲運園院油由飮醫以因"
    "任者昨章再在材的赤典戰展庭定題第族卒州注止知紙集參窓責淸體初充特表品風"
    "必河幸現號畫化訓凶黑"
)
# 4급 신출 200자
GRADE4_NEW = (
    "價甘減監改個擧健件建競景季固故骨課關觀廣橋具救求舊久局君規極給其器期汽"
    "技基念團端壇談都島到獨朗冷兩量旅練領令料類陸律望妹牧武味未倍變報富婦備"
    "比費鼻貧寫謝師査産賞商常序選鮮船仙善說星聖盛聲城誠勢歲束送授守視試識氏"
    "惡眼案暗約養餘熱葉藝屋完往曜浴雨雄願偉爲恩義移將財災爭低貯敵傳切節店情"
    "停精政祭際濟制製除鳥助早造尊宗走竹準衆增志指支至職進眞"
)
# 4급 600자 보충용 (중복 시 부족분 채우기)
SUPPLEMENT_4 = (
    "假街講康檢潔缺境經警慶係官求句究權極禁器起暖難怒努斷單檀端達擔黨帶隊導"
    "毒督銅斗豆得燈羅兩麗連列錄論留律滿脈毛牧務武未味密博防房訪拜背配罰伐壁"
)

# 획수 (일반적 값, 누락 시 사용)
STROKES = {
    "九":2,"金":8,"南":9,"男":7,"女":3,"東":8,"六":4,"母":5,"木":4,"門":8,"父":4,"北":5,
    "四":5,"三":3,"西":6,"水":4,"十":2,"五":4,"月":4,"二":2,"人":2,"一":1,"日":4,"子":3,
    "弟":7,"七":2,"八":2,"兄":5,"火":4,"江":6,"口":3,"內":4,"年":6,"大":3,"目":5,"白":5,
    "山":3,"上":3,"小":3,"手":4,"足":7,"外":5,"右":5,"入":2,"左":5,"中":4,"靑":8,"出":5,
    "下":3,"犬":4,"己":3,"林":8,"馬":10,"名":6,"百":6,"生":5,"石":5,"先":6,"姓":8,"心":4,
    "羊":6,"魚":11,"玉":5,"牛":4,"耳":6,"地":6,"川":3,"千":3,"天":4,"車":7,"巾":3,"古":5,
    "工":3,"今":4,"同":6,"力":2,"立":5,"末":5,"文":4,"方":4,"本":5,"夫":4,"不":4,"士":3,
    "夕":3,"世":5,"少":4,"食":9,"央":5,"王":4,"位":7,"衣":6,"字":6,"自":6,"正":5,"主":5,
    "寸":3,"向":6,"休":6,
}

def get_strokes(c):
    return STROKES.get(c, 10)

def build_all_chars_list(char_db=None):
    """대한검정회 순서 전체 문자 리스트 (8~4급 누적 600자)"""
    all_chars = []
    for char, meaning, sound in GRADE8_HUNUM + GRADE7_HUNUM + GRADE6_HUNUM + GRADE_PRE5_HUNUM:
        all_chars.append((char, meaning, sound))
    # 5급 150자
    HUNUM_5 = {
        "歌":"노래,가","家":"집,가","各":"각각,각","間":"사이,간","强":"강할,강","開":"열,개",
        "去":"갈,거","見":"볼,견","京":"서울,경","計":"셀,계","高":"높을,고","功":"공,공",
        "空":"빌,공","共":"함께,공","科":"과목,과","光":"빛,광","敎":"가르칠,교","交":"사귈,교",
        "校":"학교,교","區":"나눌,구","國":"나라,국","軍":"군사,군","近":"가까울,근","急":"급할,급",
        "旗":"기,기","記":"기록할,기","氣":"기운,기","農":"농사,농","多":"많을,다","短":"짧을,단",
        "答":"대답,답","當":"마땅할,당","對":"대답할,대","代":"대신할,대","道":"길,도","刀":"칼,도",
        "讀":"읽을,독","冬":"겨울,동","洞":"골,동","頭":"머리,두","等":"무리,등","登":"오를,등",
        "樂":"즐거울,락","來":"올,래","老":"늙을,로","理":"다스릴,리","里":"마을,리","利":"이로울,리",
        "萬":"일만,만","每":"매양,매","面":"낯,면","命":"목숨,명","明":"밝을,명","毛":"털,모",
        "無":"없을,무","聞":"들을,문","問":"물을,문","物":"것,물","米":"쌀,미","民":"백성,민",
        "班":"나눌,반","半":"절반,반","放":"놓을,방","番":"차례,번","別":"다를,별","步":"걸음,보",
        "部":"거느릴,부","分":"나눌,분","社":"모일,사","事":"일,사","死":"죽을,사","色":"빛,색",
        "書":"글,서","線":"줄,선","性":"성품,성","成":"이룰,성","所":"바,소","首":"머리,수",
        "詩":"글,시","時":"때,시","示":"보일,시","市":"저자,시","植":"심을,식","神":"귀신,신",
        "身":"몸,신","信":"믿을,신","新":"새로울,신","室":"집,실","安":"편안할,안","夜":"밤,야",
        "弱":"약할,약","語":"말,어","言":"말씀,언","永":"길,영","英":"꽃부리,영","午":"낮,오",
        "用":"쓸,용","友":"벗,우","遠":"멀,원","原":"언덕,원","元":"으뜸,원","有":"있을,유",
        "肉":"고기,육","育":"기를,육","銀":"은,은","音":"소리,음","邑":"고을,읍","意":"뜻,의",
        "作":"지을,작","長":"긴,장","場":"마당,장","才":"재주,재","田":"밭,전","電":"번개,전",
        "前":"앞,전","全":"온전할,전","朝":"아침,조","祖":"할아비,조","晝":"낮,주","住":"살,주",
        "竹":"대,죽","重":"무거울,중","直":"곧을,직","草":"풀,초","村":"마을,촌","秋":"가을,추",
        "春":"봄,춘","親":"친할,친","太":"클,태","通":"통할,통","貝":"조개,패","便":"편할,편",
        "平":"평평할,평","夏":"여름,하","學":"배울,학","韓":"한나라,한","漢":"한수,한","合":"합할,합",
        "海":"바다,해","行":"다닐,행","血":"피,혈","形":"모양,형","花":"꽃,화","話":"말씀,화",
        "和":"화할,화","活":"살,활","黃":"누를,황","會":"모일,회","孝":"효도,효","後":"뒤,후",
    }
    for c in GRADE5_NEW:
        v = HUNUM_5.get(c, "훈,음")
        parts = v.split(",")
        m, s = (parts[0], parts[1]) if len(parts) >= 2 else ("훈", "음")
        all_chars.append((c, m, s))
    # 준4급 150자 - 훈음 간략
    PRE4_HUNUM = {
        "加":"더할,가","可":"옳을,가","角":"뿔,각","感":"느낄,감","客":"손님,객","格":"격식,격",
        "決":"결단할,결","結":"맺을,결","輕":"가벼울,경","敬":"공경할,경","界":"지경,계",
        "苦":"괴로울,고","考":"상고할,고","告":"알릴,고","曲":"굽을,곡","公":"공변될,공",
        "果":"과실,과","過":"지날,과","球":"공,구","郡":"고을,군","貴":"귀할,귀","根":"뿌리,근",
        "級":"등급,급","吉":"길할,길","能":"능할,능","堂":"집,당","待":"기다릴,대","德":"덕,덕",
        "圖":"그림,도","度":"법도,도","童":"아이,동","動":"움직일,동","落":"떨어질,락",
        "良":"어질,량","歷":"지낼,력","例":"법식,례","禮":"예도,례","路":"길,로","勞":"수고로울,로",
        "綠":"푸를,록","流":"흐를,류","李":"오얏,리","亡":"망할,망","買":"살,매","賣":"팔,매",
        "美":"아름다울,미","朴":"순박할,박","反":"돌이킬,반","發":"필,발","法":"법,법",
        "兵":"군사,병","病":"병,병","福":"복,복","服":"옷,복","奉":"받들,봉","冰":"얼음,빙",
        "仕":"벼슬할,사","思":"생각,사","史":"역사,사","使":"하여금,사","算":"셈,산",
        "相":"서로,상","席":"자리,석","雪":"눈,설","省":"살필,성","洗":"씻을,세","消":"사라질,소",
        "速":"빠를,속","孫":"손자,손","樹":"나무,수","數":"셈,수","宿":"잠잘,숙","順":"순할,순",
        "術":"재주,술","習":"익힐,습","勝":"이길,승","始":"처음,시","式":"법,식","臣":"신하,신",
        "實":"열매,실","失":"잃을,실","兒":"아이,아","愛":"사랑,애","野":"들,야","藥":"약,약",
        "陽":"볕,양","洋":"큰바다,양","漁":"고기잡을,어","億":"억,억","業":"일,업",
        "如":"같을,여","然":"그럴,연","溫":"따뜻할,온","要":"구할,요","勇":"날쌜,용",
        "雲":"구름,운","運":"움직일,운","園":"동산,원","院":"집,원","油":"기름,유",
        "由":"말미암을,유","飮":"마실,음","醫":"의원,의","以":"써,이","因":"인할,인",
        "任":"맡길,임","者":"놈,자","昨":"어제,작","章":"글,장","再":"두,재","在":"있을,재",
        "材":"재목,재","的":"과녁,적","赤":"붉을,적","典":"법,전","戰":"싸움,전","展":"펼,전",
        "庭":"뜰,정","定":"정할,정","題":"제목,제","第":"차례,제","族":"겨레,족","卒":"군사,졸",
        "州":"고을,주","注":"물댈,주","止":"그칠,지","知":"알,지","紙":"종이,지","集":"모일,집",
        "參":"참여할,참","窓":"창문,창","責":"꾸짖을,책","淸":"맑을,청","體":"몸,체",
        "初":"처음,초","充":"채울,충","特":"특별할,특","表":"겉,표","品":"물건,품",
        "風":"바람,풍","必":"반드시,필","河":"물,하","幸":"다행,행","現":"나타날,현","號":"이름,호",
        "畫":"그림,화","化":"될,화","訓":"가르칠,훈","凶":"흉할,흉","黑":"검을,흑",
    }
    for c in GRADE_PRE4_NEW:
        if c in PRE4_HUNUM:
            m, s = PRE4_HUNUM[c].split(",")
        else:
            m, s = "훈", "음"
        all_chars.append((c, m, s))
    # 4급 200자 (중복 제외)
    seen = {x[0] for x in all_chars}
    for c in GRADE4_NEW:
        if c not in seen:
            seen.add(c)
            all_chars.append((c, "훈", "음"))
    # 600자까지 보충 (부족 시 SUPPLEMENT_4 → char_db 순)
    for c in SUPPLEMENT_4:
        if len(all_chars) >= 600:
            break
        if c not in seen:
            seen.add(c)
            if char_db and c in char_db:
                e = char_db[c]
                all_chars.append((c, e.get("meaning", "훈"), e.get("sound", "음")))
            else:
                all_chars.append((c, "훈", "음"))
    if len(all_chars) < 600 and char_db:
        for c, e in char_db.items():
            if len(all_chars) >= 600:
                break
            if c not in seen:
                seen.add(c)
                all_chars.append((c, e.get("meaning", "훈"), e.get("sound", "음")))
    return all_chars

def build_categories(data):
    char_to_idx = {e["character"]: i for i, e in enumerate(data)}
    categories = {"숫자": [], "자연": [], "사람/가족": [], "방향/위치": [], "학교/학문": [], "생활/일상": [], "기타": []}
    for cat, chars in [
        ("숫자", "一二三四五六七八九十百千萬億"),
        ("자연", "日月火水木金土山川江河海天地花草春夏秋冬風雪雨雲羊"),
        ("사람/가족", "人父母子女男女兄弟祖孝童孫士兒姉妹"),
        ("방향/위치", "東西南北上下左右中內外前後境"),
        ("학교/학문", "學校教文字問記算數書讀題史師"),
        ("생활/일상", "食休安住場市工農電家室門道路里村洞會社店房"),
    ]:
        for c in chars:
            if c in char_to_idx:
                categories[cat].append(char_to_idx[c])
    all_cat = set()
    for v in categories.values():
        all_cat.update(v)
    categories["기타"] = [i for i in range(len(data)) if i not in all_cat]
    return {k: sorted(v) for k, v in categories.items() if v}

def main():
    db = load_char_db()
    all_chars = build_all_chars_list(char_db=db)
    
    # 급수별 누적 인덱스
    GRADE_LIMITS = [
        (30, "default8.json", "8급"),
        (50, "default7.json", "7급"),
        (70, "default6.json", "6급"),
        (100, "default_pre5.json", "준5급"),
        (250, "default5.json", "5급"),
        (400, "default_pre4.json", "준4급"),
        (600, "default4.json", "4급"),
    ]
    
    for limit, fname, label in GRADE_LIMITS:
        data = []
        for i, (char, meaning, sound) in enumerate(all_chars[:limit]):
            if char in db:
                data.append(db[char])
            else:
                strokes = STROKES.get(char, 10)
                data.append(make_entry(char, meaning, sound, strokes))
        categories = build_categories(data)
        result = {"version": "0.5", "data": data, "categories": categories}
        with open(fname, "w", encoding="utf-8") as f:
            json.dump(result, f, ensure_ascii=False, indent=2)
        print(f"{fname} 생성 완료: {label} {len(data)}자")
    
    print("\n대한검정회 기준 급수별 JSON 생성 완료")
    print("8급(30) → 7급(50) → 6급(70) → 준5급(100) → 5급(250) → 준4급(400) → 4급(600)")

if __name__ == "__main__":
    main()
